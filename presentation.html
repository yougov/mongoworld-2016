<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>From the Polls to the Trolls: Seeing What The World Thinks at YouGov</title>

		<meta name="description" content="YouGov showcases their global cluster at MongoWorld 2016">
		<meta name="author" content="YouGov, Plc.">

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="https://jaraco.github.io/reveal.js/css/reveal.css">
		<link rel="stylesheet" href="https://jaraco.github.io/reveal.js/css/theme/black.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="https://jaraco.github.io/reveal.js/lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			var path = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			link.href = 'https://jaraco.github.io/reveal.js/' + path;
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

	</head>

	<body>

		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

				<section>
					<h1>From the Polls to the Trolls</h1>
					<h3>Seeing what the world thinks at <a href="https://today.yougov.com/">YouGov</a></h3>
				</section>

				<section>
					<ul>
						<li style="padding: 1em;">YouGov conducts highly dynamic surveys that rely on MongoDB's rich support for semi-structured data.</li>

						<li style="padding: 1em;">YouGov uses tag-aware sharding to provide MongoDB-as-a-Service (MongoDBaaS) for a global operation.</li>

						<li style="padding: 1em;">MongoDB is a joy to use and an effective multipurpose persistence store for large-scale applications.</li>
					</ul>
				</section>

				<section>
					<section>
						<h1>Two Challenges</h1>
						<!--
						YouGov faces many challenges,
						but today we will discuss two
						that are particularly salient to
						this audience.
						-->
					</section>

					<section>
						<h2>Challenge: Survey Collection</h2>
						<ul>
							<li>highly dynamic surveys</li>
							<li>programmed by users</li>
							<li>semi-structured data</li>
							<li>high throughput <!-- daily peak submission rate approaches 4K/minute --></li>
							<li><em>increasing</em> throughput <!-- 5GB/mo during 2011; 90GB/mo during 2015 Q4 --></li>
						</ul>
					</section>

					<section>
						<h2>Challenge: Global Operation</h2>
						<ul>
							<li>YouGov operates in 23 countries on 5 continents</li>
							<li>local responsiveness crucial</li>
							<li>avoid specialized datastore</li>
							<li>jurisdictional constraints</li>
						</ul>
						<!-- before we go into the talk, allow
						me to briefly tell you about YouGov. -->
					</section>
				</section>

				<section>
					<section>
						<h2>About Us</h2>
					</section>

					<section>
						<h2>About YouGov</h2>
						<ul>
							<li>community <!-- voluntary participation --></li>
							<li>opinions &amp; habits</li>
							<li>smart analysis</li>
							<li>insights and prediction</li>
						</ul>
					</section>

					<section>
						<h2>About YouGov DevOps</h2>
						<ul>
							<li>heavily leverage Python and open-source</li>
							<li>streamlined deployment <!-- near-continuous --></li>
						</ul>
					</section>

					<section>
						<h2>About Jason</h2>
						<ul>
							<li>passion for Python</li>
							<li>studied web data (semi-structured)</li>
							<li>motivated by relational constraints <!-- Want to mention friction of ORMs and managing semi-structured data in a highly structured database. --></li>
						</ul>
					</section>

					<section>
						<h2>About Bryan</h2>
						<ul>
							<li>experienced developer</li>
							<li>implemented sharding strategy</li>
						</ul>
					</section>
				</section>

				<section>
					<section>
						<h2>The Plan</h2>
					</section>

					<section>
						<!-- connect back to two challenges -->
						<h2>Flexible Data Model</h2>
						<ul>
							<li>store survey responses as document <!-- originally as a blob --></li>
							<li>(automatic) schema migration</li>
						</ul>
					</section>

					<section>
						<h2>Global Sharded Cluster</h2>
						<ul>
							<li>2 datacenters separated by 5,400 miles</li>
							<li>partitions survey data via tag-aware sharding</li>
							<li>provides Database-as-a-Service (DBaaS)<!-- a part of the infrastructure available to any and all applications --></li>
						</ul>
					</section>
				</section>

				<section>
					<h2>Diving In</h2>
					<!-- Here, we'll go into depth on our two key observations -->
				</section>

				<section>

					<!-- First, we showcase the code for the migration manager and show how it plugs into the load side of the interface. Show a few canonical manifestations including one that renames a field. Share risks of renaming a field (queries, indexes), situations where that doesn't apply, and ways to mitigate the issue. -->

					<section>
						<h2>Migration Manager</h2>
						<ul>
							<li>schema version</li>
							<li>incrementing integer</li>
							<li>migrates on load</li>
							<li>untouched on save</li>
						</ul>
					</section>

					<section>
						<h2>Python Code</h2>
						...
					</section>

					<section>
						<h2>Caution: Field Rename</h2>
						<!-- some field rename operations require special consideration -->
						<ul>
							<li>queries</li>
							<li>indexes</li>
						</ul>
					</section>

					<section>
						<h2>Mitigation</h2>
						<ul>
							<li>support both fields</li>
							<li>maintain dual indexes</li>
							<li>backfill migration</li>
						</ul>
					</section>

				</section>

				<section>
					<!-- Second, Bryan will now showcase the global cluster architecture. (consider "transparent partitioning" as a clarifying synonym for sharding). Go into detail about the advantages and challenges of this approach (shard key selection, ensuring targeted queries even during partition, which is likely across continents). -->

					<section>
						<h2>Global Sharded Cluster</h2>
						<ul>
							<li>2 datacenters
								<ul>
									<li>London ("EMEA")</li>
									<li>Palo Alto, CA ("US")</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Global Sharded Cluster</h2>
						<ul>
							<li>6 shards <!-- Each shard is a replica set with (typically) 3 data-bearing members. -->
								<ul>
									<li>3 in EMEA</li>
									<li>2 in US</li>
									<li>1 with RS members in EMEA & US</li><!-- referred to affectionately as "EARTH1" -->
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Survey Data Schema</h2>
						<ul>
							<li>an interview represents 1 user's responses to 1 survey</li>
						</ul>
						<pre><code>{
	region: "EMEA",
	panel_id: 15,
	survey_id: "rfc1274",
	user_id: 216074,
	responses: {
		favourite_drink: "chocolate milk",
		// ...
	}
}</code></pre>

					</section>

					<section>
						<h2>Interview Life Cycle</h2>
						<!-- There are 2 natural phases of the interview life cycle. -->
						<ul>
							<li>collection phase
								<ul>
									<li>relatively short</li>
									<li>very active reads/writes</li>
									<li>most queries target a single document</li>
								</ul>
							</li>
							<li>retention phase
								<ul>
									<li>indefinitely long</li>
									<li>sporadic reads</li>
									<li>neglible writes</li>
									<li>most queries target groups of documents</li>
								</ul>
							</li>
						</ul>
					</section>

					<section>
						<h2>Shard Key Selection</h2>
						<ul>
							<li>{region: 1, user_id: 1}</li>
							<li>{region: 1, survey_id: 1}</li>
						</ul>
					</section>

					<section>
						<h2>Tag-Aware Sharding</h2>
						<ul>
							<li>sh.addShardTag(...)</li>
							<li>sh.shardCollection(...)</li>
							<li>sh.addTagRange(...)</li>
						</ul>
					</section>

					<section>
						<h2>Caution: Non-Targeted Queries</h2>
					</section>

					<section>
						<h2>(Mongo) Database-as-a-Service</h2>
						<ul>
							<li><em>mongos</em> instance running on each app server</li>
							<li>applications connect to mongodb://localhost/</li>
						</ul>
					</section>

					<section>
						<h2>Read Preference "nearest"</h2>
						<ul>
							<li>provides low-latency reads when using geographically distributed replica sets</li>
						</ul>
						<!-- read preference defaults to ReadPreference.PRIMARY -->
						<pre><code>from pymongo import MongoClient, ReadPreference

# set read preference on the client
mongo = MongoClient('localhost',
                    read_preference=ReadPreference.NEAREST)

# ...or on an individual database
mongo = MongoClient('localhost')
db = mongo.get_database('dragoman',
                        read_preference=ReadPreference.NEAREST)</code></pre>
					</section>

				</section>

				<section>
					<section>
						<h2>Predictions</h2>
						<ul>
							<li>migrate with whimsy</li>
							<li>all apps in global cluster</li>
						</ul>
					</section>

					<section>
						<h2>Database Creation</h2>
						<pre><code>def create_db_in_shard(db_name, shard, client=None):
	"""
	In a sharded cluster, create a database in a particular shard.
	"""
	client = client or pymongo.MongoClient()
	# flush the router config to ensure it's not stale
	res = client.admin.command('flushRouterConfig')
	if not res.get('ok'):
		raise RuntimeError("unable to flush router config")
	if shard not in get_ids(client.config.shards):
		raise ValueError(nf("Unknown shard {shard}"))
	if db_name in get_ids(client.config.databases):
		raise ValueError("database already exists")
	# MongoDB doesn't have a 'create database' command, so insert an
	#  item into a collection and then drop the collection.
	client[db_name].foo.insert({'foo': 1})
	client[db_name].foo.drop()
	if client[db_name].collection_names():
		raise ValueError("database has collections")
	res = client.admin.command('movePrimary', value=db_name, to=shard)
	if not res.get('ok'):
		raise RuntimeError(str(res))
	return nf("Successfully created {db_name} in {shard} via {hostname}")</code></pre>
					</section>

					<section>
						<h2>Multi-Dimensional Partitioning</h2>
						<ul>
							<li>still partition for archival</li>
							<li>managed programmatically</li>
							<li>seek additional layers of partitioning</li>
						</ul>
					</section>

					<section>
						<h2>Partitioning Motives</h2>
						<ul>
							<li>locality</li>
							<li>distribution (size)</li>
							<li>distribution (performance)</li>
							<li>storage </li>
						</ul>
					</section>

					<section>
						<h2>Wishes</h2>
						<ul>
							<li>Supply shard hint, independent from query <!--todo: find JIRA ref --></li>
							<li>Generalized custom shard logic, independent from data in records</li>
						</ul>
					</section>
				</section>

				<section>
					<section>
						<h2>Conclusions</h2>
						<ul>
							<li>If you have dynamically changing data, choose a schemaless database. Take advantage of the schemaless aspects and migrate with whimsy.</li>
							<li>When your company is successful and international, use tag-aware sharding to achieve partitioning of your data without losing control, but let MongoDB manage the abstraction.</li>
						</ul>
					</section>
				</section>

				<section>
					<h1>Questions?</h1>
				</section>

			</div>

		</div>

		<script src="https://jaraco.github.io/reveal.js/lib/js/head.min.js"></script>
		<script src="https://jaraco.github.io/reveal.js/js/reveal.js"></script>

		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'https://jaraco.github.io/reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'https://jaraco.github.io/reveal.js/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'https://jaraco.github.io/reveal.js/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'https://jaraco.github.io/reveal.js/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'https://jaraco.github.io/reveal.js/plugin/zoom-js/zoom.js', async: true },
					{ src: 'https://jaraco.github.io/reveal.js/plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>

</html>
